name: Finalize a test round

on: workflow_dispatch

env:
  NODE_VERSION: 16.x
  FACTORY_ADDRESS: 0xe7b5bc91033861ed521898df744343b3c61b1ee7
  SUBGRPAH_URL: https://api.thegraph.com/subgraphs/name/yuetloo/clrfund-arbitrum-goerli
  NETWORK: arbitrum-goerli
  COORDINATOR_ETH_PK: ${{ secrets.COORDINATOR_ETH_PK }}
  COORDINATOR_PK: ${{ secrets.COORDINATOR_PK }}

jobs:
  setup:
    runs-on: ubuntu-22.04
    steps:
    - name: Use Node.js ${{ env.NODE_VERSION }}
      uses: actions/setup-node@v3
      with:
        node-version: ${{ env.NODE_VERSION }}
    - name: Install g++ library dependencies
      run: |
        sudo apt update
        sudo apt-get install build-essential libgmp-dev libsodium-dev nlohmann-json3-dev nasm g++ curl
    - name: Install rust toolchain
      uses: actions-rs/toolchain@v1
      with:
        toolchain: stable
    - name: Install zkutil
      run: |
        cargo install zkutil --version 0.3.2
    - name: Checkout source code
      uses: actions/checkout@v3
    - name: Download batch 64 params
      run: |
        ls -la $GITHUB_WORKSPACE
        $GITHUB_WORKSPACE/.github/scripts/download-batch64-params.sh
    - name: Build
      run: |
        yarn && yarn build
    - name: Run finalize scripts
      run: |
        export NODE_CONFIG=$(node -e "const snarkParamsPath=process.env.GITHUB_WORKSPACE + '/params'; console.log(JSON.stringify({ snarkParamsPath }));")
        export ROUND=$(curl -X POST -d '{"query":"{fundingRoundFactories {currentRound {id}}}"}' $SUBGRPAH_URL)
        export ROUND_ADDRESS=$(node -e 'console.log(JSON.parse(process.env.ROUND).data.fundingRoundFactories[0].currentRound.id)')
        # tally and finalize
        cd contracts
        yarn hardhat run --network "${NETWORK}" scripts/tally.ts
        yarn hardhat run --network "${NETWORK}" scripts/finalize.ts
